## Исследование парсинга вэб-ресурсов через прокси-сервера и TOR-прокси

Цель данного аппликейшена - протестировать возможность парсинга вэб-страницы через TOR-сервер.

Возможны 2 варианта парсинга вэб-ресурсов:

1. через прокси-сервера
2. через поднятый локально TOR-сервер

- При парсинге через прокси-сервера возможно использовать бесплатные и платные. Вероятность отклика от бесплатного сервера при тестировании его активности процентов 10%.
Это подтверждается при запуске скрипта https://github.com/alex311982/proxy/blob/master/AngryCurl/example.php. Данный скрипт загружает адреса прокси-серверов из файла и проверяет их на жизнеспособность перед парсингом необходимых вэб-ресурсов.
Список актуальных бесплатных вэб-серверов взят с http://free.proxy-sale.com/.
Результат тестирования жизнеспособности - 54 сервера из 500 отдают 200 статус код. Т.е. пригодны для проксирования.
При дальнейшем тестировании вэб-ресурсов через эти активные сервера вероятность получения 200 кода-статуса от него - рандомная и в моем случае стремилась к 0. 

- При парсинге через поднятый TOR-сервер при 100 последовательных курл-риквестов вероятность получения контента страницы без защиты от роботов и со 200 код-статусом в моем случае всегда стремилась к 100%.
Время тестирования составляло в среднем 500с. В случае тестирования мулти-курловыми запросами, которые делаются параллельно, время должно быть меньше.

# Пример реализации парсинга вэб-ресурсов через локально поднятый TOR-сервер
В данном коде была использована библиотека для смены IP в случае блокировки контента со стороны отдающего вэб-страницу сервера. По дэфолту установлены параметры для смены IP если 3 блокировки из 5 запросов.
Это число можно поменять в файле index.php.

Результат при запуске index.php раз в 1 минуту по крону при вышеуказаных настройках - 95% получения страницы без каптчи.

Шаги для развертывания:

1. Установить TOR-сервер по руководству https://www.torproject.org/docs/installguide.html.en для необходимой OS
После установки сервера он не стает частью TOR-сети. По умолчанию Tor будет работать в режиме клиента сети: вы можете им воспользоваться для работы с сетью, но для для других этот экземпляр будет бесполезен. Чужой трафик через него идти не будет. 
Информация взята со статьи https://habrahabr.ru/post/228971/
2. Генерируем пароль для подключения к локальному TOR-серверу. В консоле набираем
tor --hash-password my_password
Где my_password - желаемый пароль
3. Редактируем файл с настройками TOR-сервера. Открываем файл /etc/tor/torcc.
И раскомментируем строки

```
...
ControlPort 9051
...
HashedControlPassword ПАРОЛЬ_СГЕНЕРИРОВАННЫЙ_ЧЕРЕЗ_КОНСОЛЬ
CookieAuthentication 0
````

Обратите внимение, что значение CookieAuthentication надо выставить в 0
4. Устанавливаем библиотеку. В консоли набираем
composer install
5. Открываем файл index.php и меняем при необходимости значения констант.
Обязательно меняем значение константы TOR_PASSWORD на значение, которое задали в консоли в пункте 2.
6. В кроне прописываем запуск скрипта через определенный промежуток времени. В консоли набираем crontab -e и вставляем сроку, например, раз в минуту
```
* * * * * /usr/bin/php {%полный путь к папке с проектом%}/index.php >> {%полный путь к папке с проектом%}/results_with_reload_IP.txt
```
7. Перезагружаем крон. В консоли набираем sudo service sron reload

Пример сгенерированого файла за сутки работы крона можно посмотреть в папке release.